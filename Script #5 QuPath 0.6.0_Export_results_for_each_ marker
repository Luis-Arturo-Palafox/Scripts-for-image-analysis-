import qupath.lib.scripting.QP
import java.io.File

// ========== CONFIGURACI√ìN ==========
def outputFile = new File("C:/Users")
// ===================================

// Verificar que hay un proyecto abierto
def project = QP.getProject()
if (project == null) {
    println "ERROR: No hay ning√∫n proyecto abierto en QuPath"
    return
}

// Crear carpeta si no existe
def parentDir = outputFile.getParentFile()
if (!parentDir.exists()) {
    parentDir.mkdirs()
    println "Carpeta creada: ${parentDir}"
}

println "=" * 60
println "EXPORTANDO RESULTADOS A CSV"
println "=" * 60
println "Proyecto: ${project.getName()}"
println "Total de im√°genes: ${project.getImageList().size()}"
println "Archivo de salida: ${outputFile}"
println "=" * 60

// Contador de im√°genes procesadas
int processedCount = 0
int errorCount = 0

// Crear CSV con encabezado
outputFile.withWriter('UTF-8') { writer ->
    writer.writeLine("Imagen,Total_Celulas,Positivas,Negativas,Porcentaje_Positividad")
    
    // Recorrer todas las im√°genes del proyecto
    project.getImageList().each { imageEntry ->
        try {
            def imageName = imageEntry.getImageName()
            println "\nProcesando: ${imageName}"
            
            // Leer los datos de la imagen
            def imageData = imageEntry.readImageData()
            
            if (imageData == null) {
                println "  ‚ö† Advertencia: No se pudo leer la imagen"
                writer.writeLine("${imageName},0,0,0,0.0")
                errorCount++
                return
            }
            
            def hierarchy = imageData.getHierarchy()
            
            // Obtener todas las detecciones (c√©lulas individuales)
            def detections = hierarchy.getDetectionObjects()
            
            if (detections.isEmpty()) {
                println "  ‚ö† Advertencia: No hay detecciones en esta imagen"
                writer.writeLine("${imageName},0,0,0,0.0")
                errorCount++
                return
            }
            
            // Contar c√©lulas positivas y negativas por clasificaci√≥n
            int positiveCells = 0
            int negativeCells = 0
            
            detections.each { detection ->
                def pathClass = detection.getPathClass()
                if (pathClass != null) {
                    def className = pathClass.toString()
                    
                    // Verificar si la c√©lula es positiva o negativa
                    if (className.contains("Positive")) {
                        positiveCells++
                    } else if (className.contains("Negative")) {
                        negativeCells++
                    }
                }
            }
            
            // Calcular totales y porcentaje
            int totalCells = positiveCells + negativeCells
            double percentPositive = 0.0
            
            if (totalCells > 0) {
                percentPositive = (positiveCells / totalCells) * 100.0
            }
            
            // Escribir la l√≠nea en CSV
            writer.writeLine("${imageName},${totalCells},${positiveCells},${negativeCells},${String.format('%.2f', percentPositive)}")
            
            println "  ‚úì Datos exportados: ${totalCells} c√©lulas totales"
            println "    - Positivas: ${positiveCells}"
            println "    - Negativas: ${negativeCells}"
            println "    - Positividad: ${String.format('%.2f', percentPositive)}%"
            
            processedCount++
            
            // Cerrar imagen para liberar memoria
            imageData.getServer().close()
            
        } catch (Exception e) {
            println "  ‚úó ERROR procesando imagen: ${e.getMessage()}"
            e.printStackTrace()
            errorCount++
        }
    }
}

// Resumen final
println "\n" + "=" * 60
println "RESUMEN DE EXPORTACI√ìN"
println "=" * 60
println "‚úì Im√°genes procesadas exitosamente: ${processedCount}"
println "‚úó Im√°genes con errores/advertencias: ${errorCount}"
println "üìÅ Archivo guardado en: ${outputFile}"
println "=" * 60
println "‚úÖ Exportaci√≥n completada"
