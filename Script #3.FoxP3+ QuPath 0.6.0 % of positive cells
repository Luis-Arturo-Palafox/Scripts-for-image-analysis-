// Configurar imagen y deconvolución//
setImageType('BRIGHTFIELD_H_DAB')

def deconvolutionStain = '{"Name" : "H-DAB FOXP3 Macenko", "Stain 1" : "Hematoxylin", "Values 1" : "0.8484224741995179 0.4903364394133543 0.1993727199408244", "Stain 2" : "DAB", "Values 2" : "0.38020457546892394 0.7012901108368906 0.6030229359111283", "Background" : " 182 196 219"}'

setColorDeconvolutionStains(deconvolutionStain)

// Seleccionar todas las anotaciones
selectAnnotations()

// Configuración única de PositiveCellDetection con umbral 0.13
def json = """{
    "detectionImageBrightfield":"Hematoxylin OD",
    "backgroundByReconstruction":true,
    "backgroundRadius":8.0,
    "medianRadius":0.0,
    "sigma":1.2,
    "minArea":3.0,
    "maxArea":300.0,
    "threshold":0.1,
    "maxBackground":2.0,
    "watershedPostProcess":true,
    "excludeDAB":false,
    "cellExpansion":1.0,
    "includeNuclei":true,
    "smoothBoundaries":true,
    "makeMeasurements":true,
    "thresholdCompartment":"Nucleus: DAB OD mean",
    "thresholdPositive1":0.45,
    "thresholdPositive2":0.4,
    "thresholdPositive3":0.6,
    "singleThreshold":true
}"""

// Ejecutar detección
runPlugin('qupath.imagej.detect.cells.PositiveCellDetection', json)


